version: 2.1
orbs:
  docker: circleci/docker@1.7.0

jobs:
  login-ecr:
    machine: true
    resource_class: vishal-chavda/cicdrunner
    steps:
      - checkout
      - run:
          name: Configure AWS
          command: |
            mkdir ~/.aws
            aws configure set aws_access_key_id $ACCESS_KEY
            aws configure set aws_secret_access_key $SECRET_KEY
            aws configure set default.region us-east-1
      - run:
          name: Login to AWS ECR
          command: |
            aws ecr get-login-password --region us-east-1 | docker login --username AWS --password-stdin $REPO_URL

  build-docker-image:
    machine: true
    resource_class: vishal-chavda/cicdrunner
    steps:
      - checkout
      - run:
          name: Build Docker image
          command: |
            docker build -t simpleapp .
            docker tag simpleapp:latest $REPO_URL/simpleapp:latest
          environment:
            REPO_URL: $REPO_URL

  push-docker-image:
    machine: true
    resource_class: vishal-chavda/cicdrunner
    steps:
      - checkout
      - run:
          name: Push Docker image to ECR
          command: docker push $REPO_URL/simpleapp:latest
          environment:
            REPO_URL: $REPO_URL
  cleanup:
    machine: true
    resource_class: vishal-chavda/cicdrunner
    steps:
      - checkout
      - run:
          name: Remove AWS credentials and Docker image
          command: |
            rm -rf ~/.aws
            docker rmi simpleapp $REPO_URL/simpleapp:latest -f
          
workflows:
  version: 2
  build-and-push:
    jobs:
      - login-ecr:
          context:
            - AWS            
      - build-docker-image:
          requires:
            - login-ecr
      - push-docker-image:
          requires:
            - build-docker-image
      - cleanup:
          requires:
            - push-docker-image
